{% load static %}
<title>Catalogos</title>

<link rel="stylesheet" href="{% static 'css/catalogos.css' %}">

<div class="container_body">
    <div class="container">
        <div class="header">
            <h1>Catálogos Multimedia</h1>
            <p>Explora nuestra colección de animados, anime, doramas, juegos, películas, novelas y series</p>
        </div>
        
        <div class="navigation">
            <div class="nav-buttons">
                <a href="/" class="btn btn-primary">
                    </i> Inicio
                </a>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    </i>
                    <input type="text" id="searchInput" placeholder="Buscar en catálogos...">
                </div>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-category="all">Todos</button>
                <button class="tab" data-category="animados">Animados</button>
                <button class="tab" data-category="anime">Anime</button>
                <button class="tab" data-category="doramas">Doramas</button>
                <button class="tab" data-category="games">Juegos</button>
                <button class="tab" data-category="movies">Películas</button>
                <button class="tab" data-category="novelas">Novelas</button>
                <button class="tab" data-category="series">Series</button>
            </div>
        </div>
        
        <div class="catalog-grid" id="catalogContainer">
            <!-- Los elementos del catálogo se cargarán aquí mediante JavaScript -->
        </div>
        
        <div class="pagination" id="pagination">
            <!-- La paginación se generará aquí -->
        </div>
    </div>

    <script>
        // Cargar datos desde la API
        async function loadCatalogData() {
            try {
                const response = await fetch('/catalogos/api/');
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error('Error cargando datos:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        // Variables globales
        let allCatalogData = [];
        let currentCategory = 'all';
        let currentPage = 1;
        const itemsPerPage = 12;
        let filteredData = [];

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar datos
            allCatalogData = await loadCatalogData();
            
            // Inicializar eventos
            initEvents();
            
            // Mostrar todos los elementos inicialmente
            filterAndRender();
        });

        // Inicializar eventos
        function initEvents() {
            // Eventos de pestañas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Actualizar pestaña activa
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar categoría y renderizar
                    currentCategory = this.getAttribute('data-category');
                    currentPage = 1;
                    filterAndRender();
                });
            });
            
            // Evento de búsqueda
            document.getElementById('searchInput').addEventListener('input', function() {
                currentPage = 1;
                filterAndRender();
            });
        }

        // Filtrar y renderizar elementos
        function filterAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // Filtrar por categoría
            if (currentCategory === 'all') {
                filteredData = [...allCatalogData];
            } else {
                filteredData = allCatalogData.filter(item => item.type === currentCategory);
            }
            
            // Filtrar por término de búsqueda
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.sinopsis && item.sinopsis.toLowerCase().includes(searchTerm))
                );
            }
            
            // Renderizar elementos
            renderCatalogItems();
            
            // Renderizar paginación
            renderPagination();
        }

        // Renderizar elementos del catálogo
        function renderCatalogItems() {
            const container = document.getElementById('catalogContainer');
            
            // Calcular elementos para la página actual
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentItems = filteredData.slice(startIndex, endIndex);
            
            if (currentItems.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <p>No se encontraron resultados</p>
                    </div>
                `;
                return;
            }
            
            // Generar HTML para cada elemento
            container.innerHTML = currentItems.map(item => {
                const badgeText = getCategoryBadge(item.tipo);
                
                return `
                    <div class="catalog-card">
                        <div class="card-image">
                            <img src="${item.photo || '/static/images/placeholder.jpeg'}" alt="${item.name}" onerror="this.src='/static/images/placeholder.jpeg'">
                            <span class="card-badge">${badgeText}</span>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${item.name}</h3>
                            <div class="card-details">
                                ${item.year ? `<div class="detail-item"><span class="detail-label">Año:</span><span class="detail-value">${item.year}</span></div>` : ''}
                                ${item.seasons ? `<div class="detail-item"><span class="detail-label">Temporadas:</span><span class="detail-value">${item.seasons}</span></div>` : ''}
                                ${item.chapters ? `<div class="detail-item"><span class="detail-label">Capítulos:</span><span class="detail-value">${item.chapters}</span></div>` : ''}
                                ${item.plataform ? `<div class="detail-item"><span class="detail-label">Plataforma:</span><span class="detail-value">${item.plataform}</span></div>` : ''}
                                ${item.size ? `<div class="detail-item"><span class="detail-label">Tamaño:</span><span class="detail-value">${item.size}</span></div>` : ''}
    
                            </div>
                            ${item.synopsis ? `
                                <div class="card-synopsis">
                                    <p>${item.synopsis}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obtener texto para la insignia de categoría
        function getCategoryBadge(category) {
            const categories = {
                'animados': 'Animado',
                'anime': 'Anime',
                'doramas': 'Dorama',
                'games': 'Juego',
                'movies': 'Película',
                'novelas': 'Novela',
                'series': 'Serie'
            };
            return categories[category] || category;
        }

        // Renderizar paginación
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Botón anterior
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})"></button>`;
            }
            
            // Páginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="page-dots">...</span>`;
                }
            }
            
            // Botón siguiente
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})"></button>`;
            }
            
            paginationContainer.innerHTML = paginationHTML;
        }

        // Cambiar página
        function changePage(page) {
            currentPage = page;
            filterAndRender();
            
            // Scroll suave hacia arriba
            window.scrollTo({
                top: document.getElementById('catalogContainer').offsetTop - 100,
                behavior: 'smooth'
            });
        }
    </script>
</div>